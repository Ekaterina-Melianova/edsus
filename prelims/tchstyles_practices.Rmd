---
title: 'Spatial Arrangement, Teaching Practices, and Learning Outcomes: a Mediation
  Analysis'
output:
  html_notebook:
    code_folding: hide
    highlight: kate
    theme: paper
  html_document:
    df_print: paged
---

This notebook shows a preliminary examination of the relationship between teaching practices, layout arrangements in schools and academic achievements of students. Specifically, this analysis shows how the use of team teaching and small groups space arrangements may affect math and science scores of students through multiple teaching practices. Methodologically, this notebook represents the results of mediation analysis obtained from Structural Equations Modelling (SEM).

A set of variables under consideration:

* Use of spatial arrangements, measured on a scale from 1 -- never or hardly ever to 5 -- everyday (Q26, SUS)
* Teaching practice items with 4 response options varying from 1 -- never to 4 -- every (almost every) lesson (Q12, Q15, TIMSS).
* Math and science achievements, constructed as Confirmatory Factor Analysis scores from five plausible values (TIMSS).

```{r Data pre-processing, message=FALSE, warning=FALSE, include=FALSE}
# Libraries
library(foreign)
library(dplyr)
library(tidyr)
library(tidyverse)
library(magrittr)
library(lavaan)
library(Amelia)
#install.packages("https://cran.r-project.org/bin/windows/contrib/4.1/OpenMx_2.18.1.zip", repos = NULL)
library(semPlot)
library(stargazer)
library(GPArotation)
library(semTools)
library(hrbrthemes)
library(ggplot2)
library(ggpubr)

################################################# Data pre-processing #################################################
Sys.setlocale("LC_CTYPE", "russian")

### SUS

setwd(paste0("C:/Users/", Sys.getenv("USERNAME"), '/YandexDisk/SUS_TIMSS/Data/SUS'))
tch_sus <- read.csv('export_teachers_flat.csv', sep = '\t') %>% 
  select(IDSCHOOL, IDTEACH, StratNameENG, n26_1, n26_3, n5_0, n5_1, n5_2, n5_3, n3_1)

# Defining a subject: Math (1), Science (2) or Other (3)
tch_sus$subject_cat <- paste0(tch_sus$n5_0, tch_sus$n5_1, tch_sus$n5_2, tch_sus$n5_3)
tch_sus$subject_cat <- sapply(tch_sus$subject_cat, tolower)
tch_sus$subject_math <- ifelse(str_detect(tch_sus$subject_cat, 'матем|алг|геом'), 1, 0)
tch_sus$subject_science <- ifelse(str_detect(tch_sus$subject_cat, 'фи(з|х)ик|хим|гео|раф|биол|билогия'), 1, 0)

# Fixing tecching experience
tch_sus$n3_1 <- as.character(tch_sus$n3_1)
tch_sus$n3_1 <- sub("[а-яА-Я]+", x = tch_sus$n3_1, replacement = '')
tch_sus$n3_1 <- sub(",", x = tch_sus$n3_1, replacement = '.')
tch_sus[tch_sus$IDTEACH == 306302, 'n3_1'] <- 7 # fixing manually 
tch_sus$n3_1 <- as.numeric(tch_sus$n3_1)

# Subsetting by subjects
tch_sus_math <- tch_sus %>% filter(subject_math == 1) %>% 
  select(IDSCHOOL, IDTEACH, StratNameENG, n26_1, n26_3, n3_1)
names(tch_sus_math) <- c('IDSCHOOL_ORI', 'IDTEACH_ORI', 'Region', 'Small_Groups', 'Team_Teaching', 'Teacher_Exper')

tch_sus_science <- tch_sus %>% filter(subject_science == 1) %>%
  select(IDSCHOOL, IDTEACH, StratNameENG, n26_1, n26_3, n3_1)
names(tch_sus_science) <- c('IDSCHOOL_ORI', 'IDTEACH_ORI', 'Region', 'Small_Groups', 'Team_Teaching', 'Teacher_Exper')

# Averaging by teachers if they appear within a subject area several times
# Function: summarise numeric columns, return first value of non-numeric (regions in our case)
summarise_by_col_class <- function(x){
  if(is.numeric(x)){
    return(median(x, na.rm = T))
  }
  else{
    nth(x, 1)
  }
}

tch_sus_math %<>% group_by(IDSCHOOL_ORI, IDTEACH_ORI, Region) %>%
  summarise_all(summarise_by_col_class) %>% ungroup()

tch_sus_science %<>% group_by(IDSCHOOL_ORI, IDTEACH_ORI, Region) %>%
  summarise_all(summarise_by_col_class) %>% ungroup()

### TIMSS

setwd(paste0("C:/Users/", Sys.getenv("USERNAME"), '/YandexDisk/SUS_TIMSS/Data/TIMSS/SPSS'))

# Students' achievements
bstrusm7 <- read.spss('bstrusm7.sav', use.value.labels = F, to.data.frame = T)  %>%
  select(IDSCHOOL_ORI, IDCLASS_ORI, IDSTUD_ORI, IDTEACH_ORI,
         BSMMAT01, BSMMAT02, BSMMAT03, BSMMAT04, BSMMAT05,
         BSSSCI01, BSSSCI02, BSSSCI03, BSSSCI04, BSSSCI05)

# Students' SES
bsgrusm7 <- read.spss('bsgrusm7.sav', use.value.labels = F, to.data.frame = T) %>%
  select(IDSCHOOL_ORI, IDCLASS_ORI, IDSTUD_ORI, ITSEX, BSDAGE, BSBGHER, BSDGHER)

stu_timss <- bstrusm7 %>%
  left_join(bsgrusm7, by = c('IDSCHOOL_ORI', 'IDCLASS_ORI', 'IDSTUD_ORI'))

# Teachers practices: MATH
btmrusm7 <- read.spss('btmrusm7.sav', use.value.labels = F, to.data.frame = T) %>%
  select(IDSCHOOL_ORI, IDTEACH_ORI, IDSUBJ, BTBG02, BTBG03,
         BTBG12A, BTBG12B, BTBG12C, BTBG12D, BTBG12E,  BTBG12F, BTBG12G,
         BTBM15A, BTBM15B, BTBM15C, BTBM15D, BTBM15E, BTBM15F, BTBM15G, BTBM15H)#, BTBM15I)

# Teachers practices: SCIENCE
btsrusm7 <- read.spss('btsrusm7.sav', use.value.labels = F, to.data.frame = T) %>%
  select(IDSCHOOL_ORI, IDTEACH_ORI, IDSUBJ, BTBG02, BTBG03,
         BTBG12A, BTBG12B, BTBG12C, BTBG12D, BTBG12E, BTBG12F, BTBG12G,
         BTBS15A, BTBS15B, BTBS15C, BTBS15D, BTBS15E, BTBS15F, BTBS15G,
         BTBS15H, BTBS15I, BTBS15J, BTBS15K, BTBS15L, BTBS15M, BTBS15N)

# Teachers and Students TIMSS joint: MATH
math_timss <- stu_timss %>%
  inner_join(btmrusm7, by = c('IDSCHOOL_ORI', 'IDTEACH_ORI'))

# Teachers and Students TIMSS joint: SCIENCE
science_timss <- stu_timss %>%
  inner_join(btsrusm7, by = c('IDSCHOOL_ORI', 'IDTEACH_ORI')) 
  
### Merging TIMSS and SUS
# MATH
math_timss_sus <- math_timss %>%
  left_join(tch_sus_math, by = c('IDSCHOOL_ORI', 'IDTEACH_ORI'))
math_timss_sus$IDSUBJ <- NULL

# SCIENCE
science_timss_sus <- science_timss %>%
  left_join(tch_sus_science, by = c('IDSCHOOL_ORI', 'IDTEACH_ORI'))
science_timss_sus$IDSUBJ <- NULL

# Recode
# Math
practice_vars_math <- c('BTBG12B', 'BTBG12D', 'BTBG12E',  'BTBG12F', 'BTBG12G', 'BTBM15A', 'BTBM15B', 'BTBM15C', 'BTBM15D', 'BTBM15E', 'BTBM15F')
practice_vars_math_n <- which(colnames(math_timss_sus) %in% practice_vars_math)
math_timss_sus %<>% 
  mutate_at(practice_vars_math_n, recode, '1'='4', '2'='3', '3'='2', '4'='1')
math_timss_sus[,practice_vars_math_n] <- sapply(math_timss_sus[,practice_vars_math_n], as.numeric)

# Science
practice_vars_science <- c('BTBG12A', 'BTBG12B', 'BTBG12C', 'BTBG12D', 'BTBG12E', 'BTBG12F', 'BTBG12G',
                           'BTBS15A', 'BTBS15B', 'BTBS15C', 'BTBS15D', 'BTBS15E', 'BTBS15F', 'BTBS15G',
                           'BTBS15H', 'BTBS15I', 'BTBS15J', 'BTBS15K', 'BTBS15L', 'BTBS15M', 'BTBS15N')
practice_vars_science_n <- which(colnames(science_timss_sus) %in% practice_vars_science)
science_timss_sus %<>% 
  mutate_at(practice_vars_science_n, recode, '1'='4', '2'='3', '3'='2', '4'='1')
science_timss_sus[,practice_vars_science_n] <- sapply(science_timss_sus[,practice_vars_science_n], as.numeric)

# Checking classes of variables
#lapply(1:ncol(math_timss_sus), function(i){class(math_timss_sus[,i])})
#lapply(1:ncol(science_timss_sus), function(i){class(science_timss_sus[,i])})

# Averaging by students within subject areas (since each student can have several teachers)
math_timss_sus$IDTEACH_ORI <- NULL
math_timss_sus %<>% group_by(IDSCHOOL_ORI, IDCLASS_ORI, IDSTUD_ORI) %>%
  summarise_all(summarise_by_col_class) %>% ungroup()

science_timss_sus$IDTEACH_ORI <- NULL
science_timss_sus %<>% group_by(IDSCHOOL_ORI, IDCLASS_ORI, IDSTUD_ORI)  %>%
  summarise_all(summarise_by_col_class) %>% ungroup()

# Moving all ids to the beginning of the datasets
math_timss_sus <- math_timss_sus[,c(which(names(math_timss_sus) == 'Region'),
                                    1:(which(names(math_timss_sus) == 'Region') - 1),
                                    (which(names(math_timss_sus) == 'Region') + 1):ncol(math_timss_sus))]
science_timss_sus <- science_timss_sus[,c(which(names(science_timss_sus) == 'Region'),
                                    1:(which(names(science_timss_sus) == 'Region') - 1),
                                    (which(names(science_timss_sus) == 'Region') + 1):ncol(science_timss_sus))]

# Distributions
# Science
#list <- lapply(practice_vars_math_n,
#               function(i) ggplot2::qplot(science_timss_sus[[i]],
#                                          geom = "histogram",
#                                          binwidth  = 1))

#cowplot::plot_grid(plotlist = list)
#hist(science_timss_sus$Small_Groups)
#hist(science_timss_sus$Team_Teaching)

# Math
#list <- lapply(practice_vars_science_n,
#               function(i) ggplot2::qplot(math_timss_sus[[i]],
#                                          geom = "histogram",
 #                                         binwidth  = 1))

#cowplot::plot_grid(plotlist = list)
#hist(math_timss_sus$Small_Groups)
#hist(math_timss_sus$Team_Teaching)

```

```{r Multiple imputations of missing values, message=FALSE, warning=FALSE, include=FALSE}

################################################# Multiple imputations of missing values #################################################
# MATH
# Setting bounds for imputations
max <- as.matrix(as.numeric(as.character(apply(math_timss_sus[,-1], 2 , max, na.rm = T))))
max <- as.matrix(max[4:nrow(max),])

min <- as.matrix(as.numeric(as.character(apply(math_timss_sus[,-1], 2 , min, na.rm=TRUE))))
min <- as.matrix(min[4:nrow(min),])

# Running imputation
set.seed(123)
amelia_math <- amelia(as.data.frame(math_timss_sus), m = 10, idvars = c("IDSCHOOL_ORI",
                                                         "IDCLASS_ORI",
                                                         "IDSTUD_ORI", 'Region'),
                     bounds = cbind(5:ncol(math_timss_sus), min, max))

imputed_math <- amelia_math$imputations$imp10
math_timss_sus <- imputed_math


# SCIENCE
# Setting bounds for imputations
max <- as.matrix(as.numeric(as.character(apply(science_timss_sus[,-1], 2 , max, na.rm=TRUE))))
max <- as.matrix(max[4:nrow(max),])

min <- as.matrix(as.numeric(as.character(apply(science_timss_sus[,-1], 2 , min, na.rm=TRUE))))
min <- as.matrix(min[4:nrow(min),])

# Running imputation
set.seed(123)
amelia_science <- amelia(as.data.frame(science_timss_sus), m = 10, idvars = c("IDSCHOOL_ORI", 
                                                               "IDCLASS_ORI",
                                                                "IDSTUD_ORI", 'Region'),
                      bounds = cbind(5:ncol(science_timss_sus), min, max))

imputed_science <- amelia_science$imputations$imp10
science_timss_sus <- imputed_science

# Checking distributions
#lapply(19:ncol(math_timss_sus), function(i){table(math_timss_sus[,i])})
#lapply(19:ncol(science_timss_sus), function(i){table(science_timss_sus[,i])})

```

```{r Some Distributions, message=FALSE, warning=FALSE}

################################################# Some Distributions #################################################

# Math Scores
cfa_math_scores <- '
MATH =~ BSMMAT01 + BSMMAT02 + BSMMAT03 + BSMMAT04 + BSMMAT05
'
fit_cfa_math_scores  <- cfa(cfa_math_scores, data = math_timss_sus, std.lv = T)
#summary(fit_cfa_math_scores, fit.measures = T, standardized = T)
math_timss_sus$math_scores <- as.numeric(lavPredict(fit_cfa_math_scores) * sd(math_timss_sus$BSMMAT01) + 
  mean(math_timss_sus$BSMMAT01))

# Math Scores
cfa_science_scores <- '
SCIENCE =~ BSSSCI02 + BSSSCI01 + BSSSCI03 + BSSSCI04 + BSSSCI05
'
fit_cfa_science_scores  <- cfa(cfa_science_scores, data = science_timss_sus, std.lv = T)
#summary(fit_cfa_science_scores, fit.measures = T, standardized = T)
science_timss_sus$science_scores <- as.numeric(lavPredict(fit_cfa_math_scores) * sd(science_timss_sus$BSSSCI02) +
  mean(science_timss_sus$BSSSCI02))

# Binarizing small groups and teach teaching
math_timss_sus$Small_Groups_bin <- ifelse(math_timss_sus$Small_Groups == 1,0,1)
math_timss_sus$Team_Teaching_bin <- ifelse(math_timss_sus$Team_Teaching == 1,0,1)
science_timss_sus$Small_Groups_bin <- ifelse(science_timss_sus$Small_Groups == 1,0,1)
science_timss_sus$Team_Teaching_bin <- ifelse(science_timss_sus$Team_Teaching == 1,0,1)
```

### Exploratory View

Although in the main analysis, the two characteristics of the spatial arrangement are exploited as pseudo-continuous variables, for exploratory purposes, we can take a look at their dichotomous versions and focus on the average values of academic achievements within these levels (using the layout of small groups/team teaching at least once a month -- 1 or never/almost ever -- 0).

The density graph below shows that students perform worse results if teachers exploit small groups and team teaching styles. The subsequent t-test reverberates this observation: the differences in mean math scores in the groups discussed are statistically significant.

```{r Density Plots for Math Scores}
# Small Groups
p1 <- math_timss_sus %>%
  ggplot(aes(x = math_scores, fill = factor(Small_Groups_bin,
                                            labels = c("Almost never",
                                                       'Once per month or more often'))))  +
  geom_density(alpha = .3) + 
  theme_classic() +
  scale_fill_manual(values = c('deepskyblue2', 'darksalmon')) +
  labs(x = "Math Scores", y = "Density", fill = "") + 
  geom_vline(aes(xintercept = mean(math_timss_sus[Small_Groups_bin == 1, 'math_scores'])),  
             color = "darksalmon", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(math_timss_sus[Small_Groups_bin == 0, 'math_scores'])),  
             color = "deepskyblue2", linetype = "dashed", size = 1) + 
  theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        legend.position = "bottom") + 
  ggplot2::annotate("text", label = paste0(as.character(round(mean(math_timss_sus[math_timss_sus$Small_Groups_bin == 1, 'math_scores']), 1)),
                    "\nMean Score\n(teachers use \nsmall groups layout)"), x = 400, y = 0.003, size = 4,
                    colour = "darksalmon") + 
  ggplot2::annotate("text", label = paste0(as.character(round(mean(math_timss_sus[math_timss_sus$Small_Groups_bin == 0, 'math_scores']), 1)),
                    "\nMean Score\n(teachers do not use \nsmall groups layout)"), x = 700, y = 0.003, size = 4,
                    colour = "deepskyblue2") +
  theme(legend.text = element_text(size = 10),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 10)) + 
  ggtitle("Math Scores and Small Groups (Binary)")


# Team Teaching
p2 <- math_timss_sus %>%
  ggplot(aes(x = math_scores, fill = factor(Team_Teaching_bin,
                                            labels = c("Almost never",
                                                       'Once per month or more often'))))  +
  geom_density(alpha = .3) + 
  theme_classic() +
  scale_fill_manual(values = c('deepskyblue2', 'darksalmon')) +
  labs(x = "Math Scores", y = "Density", fill = "") + 
  geom_vline(aes(xintercept = mean(math_timss_sus[Team_Teaching_bin == 1, 'math_scores'])),  
             color = "darksalmon", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(math_timss_sus[Team_Teaching_bin == 0, 'math_scores'])),  
             color = "deepskyblue2", linetype = "dashed", size = 1) + 
  theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        legend.position = "bottom") + 
  ggplot2::annotate("text", label = paste0(as.character(round(mean(math_timss_sus[math_timss_sus$Team_Teaching_bin == 1, 'math_scores']), 1)),
                                           "\nMean Score\n(teachers use \nteam teaching layout)"), x = 400, y = 0.003, size = 4,
                    colour = "darksalmon") + 
  ggplot2::annotate("text", label = paste0(as.character(round(mean(math_timss_sus[math_timss_sus$Team_Teaching_bin == 0, 'math_scores']), 1)),
                                           "\nMean Score\n(teachers do not use \nteam teaching layout)"), x = 700, y = 0.003, size = 4,
                    colour = "deepskyblue2") +
  theme(legend.text = element_text(size = 10),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 10)) + 
  ggtitle("Math Scores and Team Teaching (Binary)")

p <- ggarrange(p1, p2, ncol = 2, nrow = 1, common.legend = T, legend = 'bottom')
```

```{r fig.height=5, fig.width=10}
p
```

```{r t-test for Math Scores}
# t.tests
# MATH
t.test(math_scores ~ Small_Groups_bin, math_timss_sus)
t.test(math_scores ~ Team_Teaching_bin, math_timss_sus)
```


The picture of learning outcomes in science is somewhat different: the gaps observed in scores are either negligible (like for small groups teaching) or not significant (like for team teaching). This is compatible with the results of the t-test shown below.

```{r Density Plots for Science Scores}
# Small Groups
p1 <- science_timss_sus %>%
  ggplot(aes(x = science_scores, fill = factor(Small_Groups_bin,
                                            labels = c("Almost never",
                                                       'Once per month or more often'))))  +
  geom_density(alpha = .3) + 
  theme_classic() +
  scale_fill_manual(values = c('deepskyblue2', 'darksalmon')) +
  labs(x = "Science Scores", y = "Density", fill = "") + 
  geom_vline(aes(xintercept = mean(science_timss_sus[Small_Groups_bin == 1, 'science_scores'])),  
             color = "darksalmon", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(science_timss_sus[Small_Groups_bin == 0, 'science_scores'])),  
             color = "deepskyblue2", linetype = "dashed", size = 1) + 
  theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        legend.position = "bottom") + 
  ggplot2::annotate("text", label = paste0(as.character(round(mean(science_timss_sus[science_timss_sus$Small_Groups_bin == 1, 'science_scores']), 1)),
                    "\nMean Score\n(teachers use \nsmall groups layout)"), x = 400, y = 0.003, size = 4,
                    colour = "darksalmon") + 
  ggplot2::annotate("text", label = paste0(as.character(round(mean(science_timss_sus[science_timss_sus$Small_Groups_bin == 0, 'science_scores']), 1)),
                    "\nMean Score\n(teachers do not use \nsmall groups layout)"), x = 700, y = 0.003, size = 4,
                    colour = "deepskyblue2") +
  theme(legend.text = element_text(size = 10),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 10)) + 
  ggtitle("Science Scores and Small Groups (Binary)")

# Team Teaching
p2 <- science_timss_sus %>%
  ggplot(aes(x = science_scores, fill = factor(Team_Teaching_bin,
                                            labels = c("Almost never",
                                                       'Once per month or more often'))))  +
  geom_density(alpha = .3) + 
  theme_classic() +
  scale_fill_manual(values = c('deepskyblue2', 'darksalmon')) +
  labs(x = "Science Scores", y = "Density", fill = "") + 
  geom_vline(aes(xintercept = mean(science_timss_sus[Team_Teaching_bin == 1, 'science_scores'])),  
             color = "darksalmon", linetype = "dashed", size = 1) + 
  geom_vline(aes(xintercept = mean(science_timss_sus[Team_Teaching_bin == 0, 'science_scores'])),  
             color = "deepskyblue2", linetype = "dashed", size = 1) + 
  theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
        legend.position = "bottom") + 
  ggplot2::annotate("text", label = paste0(as.character(round(mean(science_timss_sus[science_timss_sus$Team_Teaching_bin == 1, 'science_scores']), 1)),
                                           "\nMean Score\n(teachers use \nteam teaching layout)"), x = 400, y = 0.003, size = 4,
                    colour = "darksalmon") + 
  ggplot2::annotate("text", label = paste0(as.character(round(mean(science_timss_sus[science_timss_sus$Team_Teaching_bin == 0, 'science_scores']), 1)),
                                           "\nMean Score\n(teachers do not use \nteam teaching layout)"), x = 700, y = 0.003, size = 4,
                    colour = "deepskyblue2") +
  theme(legend.position = "none",
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 10)) + 
  ggtitle("Science Scores and Team Teaching (Binary)")

p <- ggarrange(p1, p2, ncol = 2, nrow = 1, common.legend = T, legend = 'bottom')

```

```{r fig.height=5, fig.width=10}
p
```

```{r t-test for Science Scores}
# SCIENCE
t.test(science_scores ~ Small_Groups_bin, science_timss_sus)
t.test(science_scores ~ Team_Teaching_bin, science_timss_sus)
```

From now on, we can expect that team teaching and small groups styles in general do not seem to have any positive impact on academic results. However, this can vary depending on a particular practice involved during the teaching process. Further, we examine this speculation by using mediation modelling.

### Analysis

First, we conducted an exploratory factor analysis to get an overall understanding of what teaching practices can emerge based on items from TIMSS questions 12 and 15 in teacher questionnaires. For mathematics teachers, the following practical factors were formed:

1. **Practice** (applying what has been learned and practicing procedures)
2. **Following Teacher** (working in whole class under a teacher's supervision, making students memorize the rules, explaining new content to them, explaining how to solve the tasks)
3. **Interpretation / Explanation** (explaining answers by students, linking new content to prior knowledge by students)
4. **Discussion** (encouragement of classroom discussions by teachers, encourage suggestion of new problem solving directions, expression of ideas during the class by students)

The following factors were generated in a model with science teachers:

1. **Fieldwork** (students do fieldwork or observe phenomena)
2. **Memorization** (students read textbooks, use formulas, memorize facts)
3. **Experimentation** (students use evidence to support findings, conduct experiments, plan experiments, present and interpret data for experiments)
4. **Discussion** (encouraging classroom discussions by teachers, encouraging the suggestion of new problem solving directions, expression of ideas during the class by students)

Second, we created structural models for achievements in mathematics and science separately. In both models, goodness-of-fit criteria indicated models of high quality. Red links depict negative effects, green links -- positive, grey links -- insignificant. The connections from the factors to the respective items are not shown (for demonstration purposes), however, are marked by the same color. To calculate an indirect effect of a predictor to an outcome through a mediator, it is sufficient to multiply 2 coefficients -- the effect of a predictor on a mediator and of a mediator on an outcome. The total effect is a sum of direct and indirect effects.


```{r Modelling: MATH, fig.height=8, fig.width=13, message=FALSE, warning=FALSE}

################################################# Modelling: MATH ################################################# 

################# EFA
formulaEFA <- as.formula("~ BTBG12A + BTBG12B + BTBG12C + BTBG12D + BTBG12E +  BTBG12F + BTBG12G + BTBM15A + BTBM15B + BTBM15C + BTBM15D + BTBM15E + BTBM15F + BTBM15G + BTBM15H")
EFA3 <- factanal(formulaEFA,
                 factors = 3,
                 data = math_timss_sus,
                 rotation = "geominQ",
                 na.action = na.exclude)

#print(loadings(EFA3), cutoff=0.2, sort=T) #Print all the loadings

# Exclude low loadings (12A, 12C) and 15G, 15H since they substantively differ from the rest of the items
# Try 4 Factors
formulaEFA <- as.formula("~ BTBG12B + BTBG12D + BTBG12E +  BTBG12F + BTBG12G + BTBM15A + BTBM15B + BTBM15C + BTBM15D + BTBM15E + BTBM15F")
EFA4 <- factanal(formulaEFA,
                 factors = 4,
                 data = math_timss_sus,
                 rotation = "geominQ",
                 na.action = na.exclude)

#print(loadings(EFA4), cutoff=0.2, sort=T) #Print all the loadings

################# CFA
# Model:
cfa_math <- '
Discussions =~ BTBG12G + BTBG12F + BTBG12D;
Explain =~  BTBG12E + BTBG12B;
Follow_Teacher =~ BTBM15B + BTBM15A + BTBM15C + BTBM15F;
Practice =~ BTBM15D + BTBM15E;
MATH =~ BSMMAT01 + BSMMAT02 + BSMMAT03 + BSMMAT04 + BSMMAT05
'
vars_to_scale <- c('BSMMAT01', 'BSMMAT02', 'BSMMAT03', 'BSMMAT04', 'BSMMAT05')
math_timss_sus[vars_to_scale] <- scale(math_timss_sus[vars_to_scale])

# Run Lavaan:
fit_cfa_math  <- cfa(cfa_math, data = math_timss_sus, std.lv = T)
#summary(fit_cfa_math , fit.measures = T, standardized = T)

# Create the path diagram:
#semPaths(fit_cfa_math, "std", title = F, intercepts = F,
#         residuals = F, thresholds = F, label.prop = 1.8, rotation = 4)
#title("Path Diagram for the Measurement Model", line = 2)

################# SEM 

structural_math <- '
# Measurement model

Discussions =~ BTBG12G + BTBG12F + BTBG12D;
Explain =~  BTBG12E + BTBG12B;
Follow_Teacher =~ BTBM15B + BTBM15A + BTBM15C + BTBM15F;
Practice =~ BTBM15D + BTBM15E;
MATH =~ BSMMAT01 + BSMMAT02 + BSMMAT03 + BSMMAT04 + BSMMAT05;

# Associations

MATH ~ m1*Discussions + m2*Explain + m3*Follow_Teacher + m4*Practice + m5*Small_Groups + m6*Team_Teaching;

Discussions ~ d1*Small_Groups + d2*Team_Teaching;
Explain ~ e1*Small_Groups + e2*Team_Teaching;
Follow_Teacher ~ f1*Small_Groups + f2*Team_Teaching;
Practice ~ p1*Small_Groups + p2*Team_Teaching;

# Covariances

Practice ~~ Discussions;
Discussions ~~ Explain;
Explain ~~ Practice;

### Indirect effects

# Small_Groups

SG__Disc_ind := d1*m1
SG__Expl_ind := e1*m2
SG__FllwTch_ind := f1*m3
SG__Prac_ind := p1*m4

# Team_Teaching

TT__Disc_ind := d2*m1
TT__Expl_ind := e2*m2
TT__FllwTch_ind := f2*m3
TT__Prac_ind := p2*m4

# Total total

SG__ind := d1*m1 + e1*m2 + f1*m3 + p1*m4
SG__tot := m5 + SG__ind

TT__ind := d2*m1 + e2*m2 + f2*m3 + p2*m4
TT__tot := m6 + TT__ind
'

fit_structural_math <- sem(structural_math, data = math_timss_sus)
#summary(fit_structural_math, fit.measures = T, standardized = T, modindices = F)
# modindices(fit_structural_math, minimum.value = 10, sort=TRUE)[1:20,]

# Manually fixing the layout
path_test <- semPaths(fit_structural_math, 'std', intercepts = F,
                      residuals = F, thresholds = F, colFactor = 0,
                      label.prop = 1.3, optimizeLatRes = T, mar = c(2,2,2,2),
                      rotation = 2, esize = 2, layout = 'tree2',
                      equalizeManifests = F, DoNotPlot = T)
layout <- path_test$layout
layout[1,] <- c(0.5, -1)
layout[2,] <- c(0.5, -0.8)
layout[3,] <- c(0.5, -0.6)
layout[10,] <- c(0.5, 0.8)
layout[11,] <- c(0.5, 1)
layout[12,] <- c(-0.5, -1)
layout[13,] <- c(-0.5, 1)
layout[23,] <- c(0.5, 0.2)
layout[19,] <- c(0, -1)
layout[20,] <- c(0, -0.25)
layout[21,] <- c(0, 0.15)
layout[22,] <- c(0, 1)

# Generating a vector with colors depending on a significance and sign
st_Sol <- standardizedSolution(fit_structural_math)
obj <- semPlotModel(fit_structural_math)
Pars <- as.data.frame(obj@Pars)
st_Sol$rhs_ <- ifelse(st_Sol$op == '~', st_Sol$lhs, st_Sol$rhs)
st_Sol$lhs_ <- ifelse(st_Sol$op == '~', st_Sol$rhs, st_Sol$lhs)
st_Sol$lhs <- NULL
st_Sol$rhs <- NULL

Pars_st_Sol <- Pars %>% select(lhs, edge, rhs) %>%
  left_join((st_Sol %>% select(lhs_, op, rhs_, pvalue, est.std) %>%
               rename(lhs = lhs_, rhs = rhs_)),
            by = c('lhs', 'rhs'))
Pars_st_Sol$pvalue <- round(as.numeric(Pars_st_Sol$pvalue), 3)
Pars_st_Sol$pvalue[is.na(Pars_st_Sol$pvalue)] <- 0
Pars_st_Sol$edge_col <- ifelse(Pars_st_Sol$est.std > 0 & Pars_st_Sol$pvalue < 0.1 & !Pars_st_Sol$op %in% c('=~', '~~'), 'darkgreen',
                               ifelse(Pars_st_Sol$pvalue > 0.1, 'lightgrey', 
                                      ifelse(Pars_st_Sol$op %in% c('=~', '~~'), 'white', 'red')))
Pars_st_Sol$edge_width <- ifelse(Pars_st_Sol$op != '=~', 1.5, 0.5)

# Plotting
path_fin <- semPaths(fit_structural_math, 'std', intercepts = F,
            residuals = F, thresholds = F, colFactor = 0,
            optimizeLatRes = F, mar = c(3,3,3,3),
            rotation = 2, layout = layout,
            nodeLabels = c('EXPRESS IDEAS', 'PROBLEM SOLVING', 'CLASSROOM DISCUSSIONS',
                           'LINK KNOWLEDGE', 'EXPLAIN ANSWERS',
                           'EXPLAIN HOW TO SOLVE', 'EXPLAIN NEW CONTENT', 'MEMORIZE RULES', 'WORK IN WHOLE CLASS',
                           'PRACTICE PROCEDURES', 'APPLY WHAT LEARNED',
                           'Small Groups', 'Team Teaching',
                           'PVMATH1', 'PVMATH2', 'PVMATH3', 'PVMATH4', 'PVMATH5',
                           'Discussion', 'Interpretation', 'Following Teacher', 'Practice',
                           'Math Scores'),
            sizeMan = 18, sizeLat = 18, sizeMan2 = 4, sizeLat2 = 4, edge.label.cex = 0.5,
            label.cex = 2.2, label.prop = 0, edge.color = Pars_st_Sol$edge_col, 
            DoNotPlot = T)

path_fin$graphAttributes$Edges$width <- Pars_st_Sol$edge_width
path_fin$graphAttributes$Nodes$color <- c(rep('#E6E600FF', 3), rep('#EF8A62', 2), rep('#FFBFFFFF', 4), 
                                          rep('#FDDBC7', 2), rep('#FFFFFFFF', 2),
                                          rep('#D1E5F0', 5), '#E6E600FF', '#EF8A62', '#FFBFFFFF',
                                          '#FDDBC7', '#D1E5F0')
plot(path_fin)
title('Arrangement of Space, Teaching Practices, and Math Outcomes')

```


```{r Modelling: SCIENCE, fig.height=8, fig.width=13, message=FALSE, warning=FALSE}

################################################# Modelling: SCIENCE ################################################# 
################# EFA 

formulaEFA <- as.formula("~ BTBG12A + BTBG12B + BTBG12C + BTBG12D + BTBG12E +  BTBG12F + BTBG12G + BTBS15A + BTBS15B + 
                         BTBS15C + BTBS15D + BTBS15E + BTBS15F + BTBS15G + BTBS15H + BTBS15I + BTBS15J + BTBS15K + BTBS15L")
EFA3 <- factanal(formulaEFA,
                 factors = 5,
                 data = science_timss_sus,
                 rotation = "geominQ",
                 na.action = na.exclude)

#print(loadings(EFA3), cutoff=0.35, sort=T) #Print all the loadings

# Exclude low loadings
# Try 4 Factors
formulaEFA <- as.formula("~ BTBG12D +  BTBG12F + BTBG12G  + BTBS15B + 
                         BTBS15C + BTBS15D + BTBS15E + BTBS15F + BTBS15G + BTBS15H + BTBS15I + BTBS15J + BTBS15K + BTBS15L")
EFA4 <- factanal(formulaEFA,
                 factors = 4,
                 data = science_timss_sus,
                 rotation = "geominQ",
                 na.action = na.exclude)

#print(loadings(EFA4), cutoff=0.2, sort=T) #Print all the loadings

################# CFA 
vars_to_scale <- c('BSSSCI01', 'BSSSCI02', 'BSSSCI03', 'BSSSCI04', 'BSSSCI05')
science_timss_sus[vars_to_scale] <- scale(science_timss_sus[vars_to_scale])

# Model:
cfa_science <- '
Discussions =~ BTBG12G + BTBG12F + BTBG12D;
Experiments =~ BTBS15F + BTBS15D + BTBS15E +  BTBS15G + BTBS15H;
Memorizing =~ BTBS15K + BTBS15I + BTBS15J;
Field_Work =~ BTBS15L + BTBS15B;
SCIENCE =~ BSSSCI02 + BSSSCI01 + BSSSCI03 + BSSSCI04 + BSSSCI05
'

# Run Lavaan:
fit_cfa_science  <- cfa(cfa_science, data = science_timss_sus, std.lv = T)
#summary(fit_cfa_science , fit.measures = T, standardized = T)

# Create the path diagram:
#semPaths(fit_cfa_science, "std", title = F, curvePivot = T, intercepts = F,
#         residuals = F, thresholds = F, label.prop = 1.8)
#title("Path Diagram for the Measurement Model", line = 2)

################# SEM 

structural_science <- '
# Measurement model

Discussions =~ BTBG12G + BTBG12F + BTBG12D;
Experiments =~ BTBS15G + BTBS15F + BTBS15D + BTBS15E + BTBS15H;
Memorizing =~ BTBS15J + BTBS15K + BTBS15I;
Field_Work =~ BTBS15B + BTBS15L;
SCIENCE =~ BSSSCI05 + BSSSCI02 + BSSSCI03 + BSSSCI04 + BSSSCI01;

# Associations

SCIENCE ~ m1*Discussions + m3*Experiments + m4*Memorizing + m5*Field_Work +
m6*Small_Groups + m7*Team_Teaching;

Discussions ~ d1*Small_Groups + d2*Team_Teaching;
Experiments ~ ex1*Small_Groups + ex2*Team_Teaching;
Memorizing ~ me1*Small_Groups + me2*Team_Teaching;
Field_Work ~ fw1*Small_Groups + fw2*Team_Teaching;

# Covariances

Field_Work ~~ Discussions;
Field_Work ~~ Experiments;
Field_Work ~~ Memorizing;
Experiments ~~ Memorizing;
Discussions ~~ Memorizing;
Discussions ~~ Experiments;
BTBS15F ~~ BTBS15H;

### Indirect effects

# Small_Groups

SG__Disc_ind := d1*m1
SG__Exper_ind := ex1*m3
SG__Memor_ind := me1*m4
SG__FldWrk_ind := fw1*m5

# Team_Teaching

TT__Disc_ind := d2*m1
TT__Exper_ind := ex2*m3
TT__Memor_ind := me2*m4
TT__FldWrk_ind := fw2*m5

# Total total

SG__ind := d1*m1 + ex1*m3 + me1*m4 + fw1*m5
SG__tot := m6 + SG__ind

TT__ind := d2*m1 + ex2*m3 + me2*m4 + fw2*m5
TT__tot := m7 + TT__ind
'
fit_structural_science <- sem(structural_science, data = science_timss_sus)
#summary(fit_structural_science, fit.measures = T, standardized = T, modindices = F)
#modindices(fit_structural_science, minimum.value = 10, sort=TRUE)[1:20,]

# Manually changing the layout
path_test <- semPaths(fit_structural_science, 'std', intercepts = F,
                      residuals = F, thresholds = F, colFactor = 0,
                      label.prop = 1.3, optimizeLatRes = T, mar = c(2,2,2,2),
                      rotation = 2, esize = 2, layout = 'tree2',
                      equalizeManifests = F, DoNotPlot = T)
layout <- path_test$layout
layout[1,] <- c(0.5, -1)
layout[2,] <- c(0.5, -0.8)
layout[3,] <- c(0.5, -0.6)

layout[12,] <- c(0.5, 0.8)
layout[13,] <- c(0.5, 1)

layout[14,] <- c(-0.5, -1)
layout[15,] <- c(-0.5, 1)

layout[25,] <- c(0.5, 0.2)
layout[21,] <- c(0, -1)
layout[22,] <- c(0, -0.25)
layout[23,] <- c(0, 0.15)
layout[24,] <- c(0, 1)

# Generating a vector with colors depending on a significance and sign
st_Sol <- standardizedSolution(fit_structural_science)
obj <- semPlotModel(fit_structural_science)
Pars <- as.data.frame(obj@Pars)
st_Sol$rhs_ <- ifelse(st_Sol$op == '~', st_Sol$lhs, st_Sol$rhs)
st_Sol$lhs_ <- ifelse(st_Sol$op == '~', st_Sol$rhs, st_Sol$lhs)
st_Sol$lhs <- NULL
st_Sol$rhs <- NULL

Pars_st_Sol <- Pars %>% select(lhs, edge, rhs) %>%
  left_join((st_Sol %>% select(lhs_, op, rhs_, pvalue, est.std) %>%
               rename(lhs = lhs_, rhs = rhs_)),
            by = c('lhs', 'rhs'))
Pars_st_Sol$pvalue <- round(as.numeric(Pars_st_Sol$pvalue), 3)
Pars_st_Sol$pvalue[is.na(Pars_st_Sol$pvalue)] <- 0
Pars_st_Sol$edge_col <- ifelse(Pars_st_Sol$est.std > 0 & Pars_st_Sol$pvalue < 0.1 & !Pars_st_Sol$op %in% c('=~', '~~'), 'darkgreen',
                               ifelse(Pars_st_Sol$pvalue > 0.1, 'lightgrey', 
                                      ifelse(Pars_st_Sol$op %in% c('=~', '~~'), 'white', 'red')))
Pars_st_Sol$edge_width <- ifelse(Pars_st_Sol$op != '=~', 1.5, 0.5)

# Plotting
path_fin <- semPaths(fit_structural_science, 'std', intercepts = F,
            residuals = F, thresholds = F, colFactor = 0,
            optimizeLatRes = F, mar = c(3,3,3,3),
            rotation = 2, esize = 2, layout = layout,
            nodeLabels = c('EXPRESS IDEAS', 'PROBLEM SOLVING', 'CLASSROOM DISCUSSIONS',
                          'INTERPRET DATA', 'PRESENT DATA', 'PLAN EXPERIMENTS', 'CONDUCT EXPERIMENTS', 'USE EVIDENCE TO SUPPORT',
                          'MEMORIZE FACTS', 'USE FORMULAS', 'READ TEXTBOOKS',
                          'OBSERVE PHENOMENA', 'DO FIELD WORK',
                          'Small Groups', 'Team Teaching',
                          'PVSCIENCE1', 'PVSCIENCE2', 'PVSCIENCE3', 'PVSCIENCE4', 'PVSCIENCE5',
                          'Discussion', 'Experimenting', 'Memorizing', 'Field Work',
                          'Science Scores'),
            sizeMan = 18, sizeLat = 18, sizeMan2 = 4, sizeLat2 = 4, edge.label.cex = 0.5,
            label.cex = 2.2, label.prop = 0, edge.color = Pars_st_Sol$edge_col, 
            DoNotPlot = T)

path_fin$graphAttributes$Edges$width <- Pars_st_Sol$edge_width
path_fin$graphAttributes$Nodes$color <- c(rep('#E6E600FF', 3), rep('#EF8A62', 5), rep('#FFBFFFFF', 3), 
                                          rep('#FDDBC7', 2), rep('#FFFFFFFF', 2),
                                          rep('#D1E5F0', 5), '#E6E600FF', '#EF8A62', '#FFBFFFFF',
                                          '#FDDBC7', '#D1E5F0')
plot(path_fin)
title('Arrangement of Space, Teaching Practices, and Science Outcomes')



```


The preliminary takeaways from these graphs are listed below.

For maths:

* On average, small groups and team teaching have a negative impact on math scores. However, their total indirect effects through teaching practices are significant and positive.

* In particular, this positive impact for small groups comes from the stimulation of interpretation practices (explanation of answers and connection with previous knowledge) and from the reduction of a teacher's governance role during the learning process.

* Positive influence on mathematical scores for the team teaching spatial arrangement comes again from uplifting the frequency of interpretation practices and encouraging discussions during the lesson.

For the science:

* On average, the effect of teaching in small groups on science scores is not statistically significant, but its indirect impact is and seems to be negative. For team teaching the global effect is also insignificant, however, the indirect is significant and positive.

* In particular, the negative effect of small groups on science scores is achieved by focusing more on the memorization practices governed by a teacher (which are not favorable for scientific scores) and by increasing the conduct of experiments (which also occurred to be unfavorable for science scores).

* In contrast, the positive effect of team teaching is achieved by reducing these 2 practices -- memorizing and experimenting - and by promoting the discussion of ideas during the learning process.

